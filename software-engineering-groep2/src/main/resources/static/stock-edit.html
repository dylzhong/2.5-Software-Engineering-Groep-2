<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Item Bewerken</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body onload="getItemIdSelectBox()">
<div class="container">
    <!-- Selecteer item -->
    <form id="form-select">
        <div class="form-group">
            <label for="select_id">Selecteer ID</label>
            <div class="box-select">
                <select class="form-control" id="select_id" name="select_id"></select>
            </div>
        </div>
    </form>

    <!-- Bewerken item -->
    <form id="form-edit">
        <div class="form-group">
            <label for="id">ID</label>
            <input class="form-control" type="text" id="id" name="id" required readonly>
        </div>
        <div class="form-group">
            <label for="ndc">National Drug Code</label>
            <input class="form-control" type="text" id="ndc" name="ndc" required>
        </div>
        <div class="form-group">
            <label for="details">Details</label>
            <input class="form-control" type="text" id="details" name="details" required>
        </div>
        <button type="button" onclick="editItem()" class="button">Bewerk</button>
        <button type="button" onclick="deleteItem()" class="button">Verwijder</button>
        <button type="button" onclick="window.location.href='stock.html'">Terug</button>
    </form>
</div>

<script>
    function getItemIdSelectBox() {
        $.getJSON("/stock", function(data) {
            let selectCode = "<option></option>";
            data.forEach((item) => {
                selectCode += `<option value="${item.id}">${item.ndc}: ${item.details}</option>`;
            });

            const select = document.getElementById("select_id");
            if (select) {
                select.innerHTML = selectCode;

                $('#select_id').select2({
                    placeholder: "Typ om item te zoeken",
                    allowClear: true,
                    width: 'resolve'
                }).on('change', function () {
                    showItemData();
                });
            }
        });
    }

    function showItemData() {
        event.preventDefault();
        const form = document.getElementById("form-select");
        const formdata = new FormData(form);
        const id = formdata.get("select_id");

        const form2 = document.getElementById("form-edit");
        form2.style.display = "block";

        $.getJSON(`/stock/get`, { id: id }, function(item) {
            document.getElementById("id").value = item.id;
            document.getElementById("ndc").value = item.ndc;
            document.getElementById("details").value = item.details;
        });
    }

    function editItem() {
        event.preventDefault();
        const formEdit = document.getElementById("form-edit");

        if (!formEdit.checkValidity()) {
            formEdit.reportValidity();
            return;
        }

        const item = {
            id: document.getElementById("id").value,
            ndc: document.getElementById("ndc").value,
            details: document.getElementById("details").value
        };

        $.get("/stock/edit", item, function(data) {
            console.log("Item bijgewerkt:", data);
            alert("Item was successfully updated");
            window.location.reload();
        });
    }

    function deleteItem() {
        event.preventDefault();
        const id = document.getElementById("id").value;

        $.get("/stock/delete", { id: id }, function(data) {
            console.log(data);
            alert("Item was successfully deleted");
            window.location.reload();
        });
    }
</script>
</body>
</html>
